# 1.文件的基本概念
## 1.1 文件的定义
1. 数据项。是文件系统中最低级的数据组织形式，可分为以下两种类型
	1. 基本数据项。用于描述一个对象的某种属性的一个值，是数据中的最小逻辑单位。
	2. 组合数据项。由多个基本数据项组成。
2. 记录。是一组相关的数据项的集合，用于描述一个对象在某方面的属性。
3. 文件。是指由创建者所定义的、具有文件名的一组相关元素的集合，可分为有结构文件和无结构文件两种。在有结构的文件中，文件由若干个相似的记录组成，如一个班的学生记录;而无结构文件则被视为一个字符流，比如一个二进制文件或字符文件。
## 1.2 文件的分类
1. 按性质和用途分类，分为系统文件、用户文件、库文件。
2. 按文件中数据的形式分类，分为源文件、目标文件、可执行文件
3. 按存取控制属性分类，分为可执行文件、只读文件、读/写文件。
4. 按组织形式和处理方式分类，分为普通文件、目录文件、特殊文件。
## 1.3 文件控制块
文件控制块(File Control Block，FCB)是用来存放控制文件需要的各种信息的数据结构以实现按名存取。文件与FCB一一对应，FCB的有序集合称为文件目录，一个FCB就是一个文件目录项。通常，一个文件目录也被视为一个文件，称为目录文件。每当创建一个新文件，系统就要为其建立一个FCB，用来记录文件的各种属性。
FCB 主要包含以下信息:
1. 基本信息，如文件名、文件的物理位置、文件的逻辑结构、文件的物理结构等。
2. 存取控制信息，包括文件主的存取权限、核准用户的存取权限以及一般用户的存取权限。
3. 使用信息，如文件建立时间、上次修改时间等。
## 1.4 索引节点
1. 磁盘索引节点
	是指存放在磁盘上的索引节点。每个文件有一个唯一的磁盘索引节点，主要包括以下内容
	1. 文件主标识符，拥有该文件的个人或小组的标识符。
	2. 文件类型，包括普通文件、目录文件或特别文件。
	3. 文件存取权限，各类用户对该文件的存取权限。
	4. 文件物理地址，每个索引节点中含有13个地址项，即iaddr(0)~iaddr(12)，它们以直接或间接方式给出数据文件所在盘块的编号
	5. 文件长度，指以字节为单位的文件长度。
	6. 文件链接计数，在本文件系统中所有指向该文件的文件名的指针计数。
	7. 文件存取时间，本文件最近被进程存取、修改的时间及索引节点最近被修改的时间
3. 内存索引节点
	是指存放在内存中的索引节点。当文件被打开时，要将磁盘索引节点复制到内存的索引节点中，便于以后使用。在内存索引节点中增加了以下内容:
	1. 索引节点号，用于标识内存索引节点。 
	2. 状态，指示i节点是否上锁或被修改。
	3. 访问计数，每当有一进程要访问此i节点时，计数加1，访问结束减1。
	4. 逻辑设备号，文件所属文件系统的逻辑设备号。
	5. 链接指针，设置分别指向空闲链表和散列队列的指针。
## 1.5 文件的操作
### 1.5.1 文件的基本操作
1. 创建文件。创建文件有两个必要步骤:一是为新文件分配外存空间;二是在目录中为之创建一个目录项，目录项记录了新文件名、文件在外存中的地址等信息。
2. 删除文件。为了删除文件，根据文件名查找目录，删除指定文件对应的目录项和文件控制块，然后回收该文件所占用的存储空间(包括磁盘空间和内存缓冲区)。
3. 读文件。为了读文件，根据文件名查找目录，找到指定文件的目录项后，从中得到被读文件在外存中的地址;在目录项中，还有一个指针用于对文件进行读操作。
4. 写文件。为了写文件，根据文件名查找目录，找到指定文件的目录项后，再利用目录项中的写指针对文件进行写操作。每当发生写操作时，便更新写指针。
### 1.5.2 文件的打开和关闭
当用户首次对某文件发出操作请求时，须先利用系统调用open将该文件打开。系统维护一个包含所有打开文件信息的表，称为打开文件表。所谓“打开”，是指系统检索到指定文件的目录项后，将该目录项从外存复制到内存中的打开文件表的一个表目中，并将该表目的索引号(也称文件描述符)返回给用户。当用户再次对该文件发出操作请求时可通过文件描述符在打开文件表中查找到文件信息，从而节省了大量的检索开销。当文件不再使用时，可利用系统调用close关闭它，则系统将会从打开文件表中删除这一表目。
当文件不再使用时，利用系统调用close关闭它，会删除单个进程的打开文件表中的相应条目，系统表中的相应打开计数器也会递减。当打开计数器为0时，表示该文件不再被使用，并且可从系统表中删除相应条目。
对于访问打开文件表的索引号，UNIX称之为文件描述符，而 Windows 称之为文件句柄。
只要完成了文件打开 open()系统调用，后面再使用 read()、write()、Lseek()、close()等文件操作的系统调用，就不再使用文件名，而使用文件描述符。该考点已反复考过多次。
每个打开文件都具有如下关联信息:
1. 文件指针。系统跟踪上次的读写位置作为当前文件位置的指针，这种指针对打开文件的某个进程来说是唯一的，因此必须与磁盘文件属性分开保存。
2. 文件打开计数。计数器跟踪当前文件打开和关闭的数量。因为多个进程可能打开同一个文件，所以系统在删除打开文件条目之前，必须等待最后一个进程关闭文件。
3. 文件磁盘位置。大多数文件操作要求系统修改文件数据。查找磁盘上的文件所需的信息保存在内存中，以便系统不必为每个操作都从磁盘上读取该信息。
4. 访问权限。每个进程打开文件都需要有一个访问模式(创建、只读、读写、添加等)。该信息保存在进程的打开文件表中，以便操作系统能够允许或拒绝后续的O 请求。
## 1.2 文件的逻辑结构
### 1.2.1 无结构文件
无结构文件是最简单的文件组织形式，它是由字符流构成的文件，所以又称流式文件，其长度以字节为单位。对流式文件的访问，是通过读/写指针来指出下一个要访问的字节的。在系统中运行的大量源程序、可执行文件、库函数等，所采用的就是无结构文件。由于无结构文件没有结构，因而对记录的访问只能通过穷举搜索的方式，因此这种文件形式对很多应用不适用。
### 1.2.2 有结构文件
有结构文件是指由一个以上的记录构成的文件，所以又称记录式文件。各记录由相同或不同数目的数据项组成，根据各记录的长度是否相等，可分为定长记录和变长记录两种。
1. 定长记录。文件中所有记录的长度都是相同的，各数据项都在记录中的相同位置，具有相同的长度。检索记录的速度快，方便用户对文件进行处理，广泛用于数据处理中。
2. 变长记录。文件中各记录的长度不一定相同，原因可能是记录中所包含的数据项数目不同，也可能是数据项本身的长度不定。检索记录只能顺序查找，速度慢。

1. 顺序文件
	文件中的记录一个接一个地顺序排列，记录可以是定长记录或变长记录。顺序文件中记录的排列有两种结构:
	1. 串结构，各记录之间的顺序与关键字无关，通常是按存入的先后时间进行排列，检索时必须从头开始顺序依次查找，比较费时;
	2. 顺序结构，所有记录按关键字顺序排列，对于定长记录的顺序文件，检索时可采用折半查找，效率较高。
2. 索引文件
	变长记录的顺序文件只能顺序查找，效率较低。为此，可以建立一张索引表，为主文件的每个记录在索引表中分别设置一个索引表项，其中包含指向记录的指针和记录长度，索引表按关键字排序，因此其本身也是一个定长记录的顺序文件
	索引文件由于需要配置索引表，且每个记录都要有一个索引项，因此增加了存储开销
3.  索引顺序
	索引顺序文件是顺序文件和索引文件的结合。最简单的索引顺序文件只使用了一级索引，先将变长记录顺序文件中的所有记录分为若干组，然后为文件建立一张索引表，并为每组中的第一个记录建立一个索引项，其中包含该记录的关键字和指向该记录的指针
4. 直接文件或散列文件
	给定记录的键值或通过散列函数转换的键值直接决定记录的物理地址。散列文件具有很高的存取速度，但是会引起冲突，即不同关键字的散列函数值可能相同。
## 1.3 文件的物理结构
1. 连续分配
	连续分配方法要求每个文件在磁盘上占有一组连续的块
	优点：
	1. 支持顺序访问和直接访问
	2. 顺序访问容易且速度快，文件所占用的块可能位于一条或几条相邻的磁道上，磁头的移动距离最小
	缺点：
	1. 要为一个文件分配连续的存储空间，与内存分配类似，为文件分配连续的存储空间会产生很多外部碎片。
	2. 必须事先知道文件的长度，也无法满足文件动态增长的要求，否则会覆盖物理上相邻的后续文件。
	3. 为保持文件的有序性，删除和插入记录时，需要对相邻的记录做物理上的移动。
2. 链接分配
	链接分配是一种采用离散分配的方式
	优点：
	1. 消除了磁盘的外部碎片，提高了磁盘的利用率
	2. 便于动态地为文件分配盘块，因此无须事先知道文件的大小。
	3. 文件的插入、删除和修改也非常方便。链接分配又可分为隐式链接和显式链接两种形式

	1. 隐式链接
		目录项中含有文件第一块的指针(盘块号)和最后一块的指针。每个文件对应一个磁盘块的链表，磁盘块分布在磁盘的任何地方。
		缺点：
		1. 只支持顺序访问，若要访问文件的第i块，则只能从第1块开始，通过盘块指针顺序查找到第i块，随机访问效率很低。
		2. 稳定性问题，文件盘块中的任何一个指针出问题，都会导致文件数据的丢失。
		3. 指向下一个盘块的指针也要耗费一定的存储空间。
	2. 显式链接
		显式链接是指将用于链接文件各物理块的指针，显式地存放在内存的一张链接表中，该表在整个磁盘中仅设置一张，称为文件分配表(File Allocation Table，FAT)。每个表项中存放指向一个盘块的指针。文件目录中只需记录该文件的起始块号，后续块号可通过查FAT找到。
		不难看出，FAT的表项与全部磁盘块一一对应，并且可以用一个特殊的数字-1表示文件的最后一块，可以用-2表示这个磁盘块是空闲的(当然也可指定为-3,-4)。因此，FAT还标记了空困的磁盘块，操作系统可以通过FAT对磁盘空闲空间进行管理。当某进程请求系统分配一个磁盘时，系统只需从P中找到-2的表项，并将对应的磁盘块分配给该进程即可。
		优点：
		1. 支持顺序访问，也支持直接访问，要访问第块，无须依次访问前i-1块
		2. FAT在系统启动时就被读入内存，检索记录是在内存中进行的，因而不仅显著提高了检索速度，而目明最减少了访问磁盘的次数。
		缺点：
		FAT需要占用一定的内存空间。
3. 索引分配
	1. 单级索引分配方式
		事实上，在打开某个文件时，只需将该文件对应的盘块的编号调入内存即可，完全没有必要将整个FAT 调入内存。为此，应该将每个文件所有的盘块号集中地放在一起，当访问到某个文件时，将该文件对应的盘块号一起调入内存即可，这就是索引分配的思想。
		索引分配的优点是支持直接访问，当要访问第i块时，索引块的第i个条目指向的便是文件的第i个块。索引分配也不会产生外部碎片。缺点是索引块增加了额外的存储空间开销。
		索引块的主要问题是，每个文件必须有一个索引块，当文件很小时，比如只有数个盘块，该方式仍为之分配一个索引块，此时索引块的利用率很低;当文件很大时，若其盘块号需要占用若干索引块，此时可通过链指针将各索引块按序链接起来，但这种方法是低效的。
	2. 多级索引分配方式
		当文件太大而索引块太多时，应该为这些索引块再建立一级索引，称为主索引，将第一个索引块的盘块号、第二个索引块的盘块号…填入该主索引表，这样，便形成了二级索引分配方式，其原理类似于内存管理中的多级页表，
		多级索引的优点:极大加快了对大型文件的查找速度。缺点:当访问一个盘块时，其所要启动磁盘的次数随着索引级数的增加而增多，即使是对数量众多的小文件也是如此。由此可见，如果在文件系统中仅采用了多级索引组织方式，那么并不能获得理想的效果。
	3. 混合索引分配方式
		为了能够较全面地照顾到小型、中型、大型和特大型文件，可采用混合索引分配方式。对于小文件，为了提高对众多小文件的访问速度，最好能将它们的每个盘块地址直接放入FCB，这就可以直接从FCB中获得该文件的盘块地址，即为直接寻址。对于中型文件，可以采用单级索引分配，需要先从FCB中找到该文件的索引表，从中获得该文件的盘块地址，即为一次间址。对于大型或特大型文件，可以采用两级和三级索引分配。
## 1.4 文件分配与簇的关系
为了提高查找速度和减小指针所占用的存储空间，可以将几个盘块组成一个簇，按而不按块来分配，可以大幅地减少查找时间，也可以改善许多算法的磁盘访问时间。比如一簇为4块这样，指针所占的磁盘空间比例也要小得多。这种方法的代价是增加了内部碎片。
# 2 文件目录
## 目录结构
1. 单级目录结构
2. 两级目录结构
3. 树形目录结构
4. 无环图目录结构
## 文件共享
1. 软连接
2. 硬连接
## 目录管理的要求
1. 实现按名存取
2. 提高对目录的检索速度
3. 方便文件共享
4. 允许文件重名
# 3 文件系统
## 3.1 文件系统结构
文件系统(File system)提供高效和便捷的磁盘访问，以便允许存储、定位、提取数据。文件系统有两个不同的设计问题:第一个问题是，定义文件系统的用户接口，它涉及定义文件及其属性、所允许的文件操作、如何组织文件的目录结构。第二个问题是，创建算法和数据结构，以便映射逐辑文件系统到物理外存设备。
1. IO 控制层
	包括设备驱动程序和中断处理程序，在内存和磁盘系统之间传输信息。设备驱动程序将输入的命令翻译成底层硬件的特定指令，硬件控制器利用这些指令使IO设备与系统交互。设备驱动程序告诉 LO 控制器对设备的什么位置采取什么动作。
2. 基本文件系统
	向对应的设备驱动程序发送通用命令，以读取和写入磁盘的物理块。每个物理块由磁盘地址标识。该层也管理内存缓冲区，并保存各种文件系统、目录和数据块的缓存。在进行盘块传输前，分配合适的缓冲区，并对缓冲区进行管理。管理它们对于系统性能的优化至关重要
3. 文件组织模块
	组织文件及其逻辑块和物理块。文件组织模块可以将文件的逻辑块地址转换为物理块地址，每个文件的逻辑块从0到N编号，它与数据的物理块不匹配，因此需要通过转换来定位。文件组织模块还包括空闲空间管理器，以跟踪未分配的块，根据需求提供给文件组织模块。
4. 逻辑文件系统
	用于管理文件系统中的元数据信息。元数据包括文件系统的所有结构,而不包括实际数据(或文件内容)。逻辑文件系统管理目录结构，以便根据给定文件名为文件组织模块提供所需要的信息。它通过文件控制块来维护文件结构。逻辑文件系统还负责文件保护。
## 3.2 文件系统布局
## 3.2.1 文件系统在磁盘中的结构
1. 主引导记录(Master Boot Record,MBR),位于磁盘的0号扇区，用来引导计算机，MBR的后面是分区表，该表给出每个分区的起始和结束地址。表中的一个分区被标记为活动分区。当计算机启动时，BIOS读入并执行MBR。MBR做的第一件事是确定活动分区读入它的第一块，即引导块。
2. 引导块(boot block)，MBR执行引导块中的程序后，该程序负责启动该分区中的操作系统。每个分区都是统一从一个引导块开始，即使它不含有一个可启动的操作系统，也不排除以后会在该分区安装一个操作系统。Windows系统称之为分区引导扇区。除了从引导块开始，磁盘分区的布局是随着文件系统的不同而变化的。
3. 超级块(super block)，包含文件系统的所有关键信息，在计算机启动时，或者在该文件系统首次使用时，超级块会被读入内存。超级块中的典型信息包括分区的块的数量、块的大小、空闲块的数量和指针、空闲的 FCB 数量和 FCB 指针等。
4. 文件系统中空闲块的信息，可以用位示图或指针链接的形式给出。后面也许跟的是一组i节点，每个文件对应一个节点,i节点说明了文件的方方面面。接着可能是根目录，它存放文件系统目录树的根部。最后，磁盘的其他部分存放了其他所有的目录和文件。
## 3.2.2 文件系统在内存中的结构
1. 内存中的安装表(mount table)，包含每个已安装文件系统分区的有关信息
2. 内存中的目录结构的缓存，包含最近访问目录的信息。
3. 整个系统的打开文件表，包含每个打开文件的FCB 副本、打开计数及其他信息。
4. 每个进程的打开文件表，包含进程打开文件的文件描述符(Windows称之为文件句柄)和指向整个系统的打开文件表中对应表项的指针。
## 3.3 磁盘空闲管理
1. 空闲表法
	空闲表法属于连续分配方式，它与内存的动态分区分配类似，为每个文件分配一块连续的存储空间。系统为外存上的所有空闲区建立一张空闲表，每个空闲区对应一个空闲表项，其中包括表项序号、该空闲区的第一个空闲盘块号、该空闲区的空闲盘块数等信息。再将所有空闲区按其起始盘块号递增的次序排列
	盘块的分配:
	空闲盘区的分配与内存的动态分配类似，也是采用首次适应算法、最佳适应算法等。例如，在系统为某新创建的文件分配空闲盘块时，先顺序地检索空闲盘块表的各表项，直至找到第一个其大小能满足要求的空闲区，再将该盘区分配给用户，同时修改空闲盘块表。
	盘块的回收:在对用户所释放的存储空间进行回收时，也采用类似于内存回收的方法，即要考虑回收区是否与空闲盘块表中插入点的前区和后区相邻接，对相邻接者应予以合并。
	空闲表法的优点是具有较高的分配速度，可减少访问磁盘的I0频率。对于较小的文件(1~5个盘块)，可以采用连续分配方式为文件分配几个相邻的盘块。
2. 空闲链表法
	1. 空闲盘块链
		空闲盘块链是指将磁盘上的所有空闲空间以盘块为单位拉成一条链。每个盘块都有指向下一个空闲盘块的指针。当用户请求分配存储空间时，系统从链首开始，依次摘下适当数目的空闲盘块分配给用户。当用户释放存储空间时，系统将回收的盘块依次插入空闲盘块链的末尾。
		空闲盘块链的优点是分配和回收一个盘块的过程非常简单。缺点是在为一个文件分配盘块时可能要重复操作多次，效率较低;又因它是以盘块为单位的，空闲盘块链会很长。
	2. 空闲盘区链
		空闲盘区链是指将磁盘上的所有空闲盘区拉成一条链，每个盘区包含若干相邻的盘块。每个盘区含有下一个空闲盘区的指针和本盘区的盘块数。分配盘区的方法与内存的动态分区分配类似，通常采用首次适应算法。回收盘区时，同样也要将回收区与相邻接的空闲盘区合并。
		空闲盘区链的优缺点正好与空闲盘块链的相反，优点是分配与回收的效率较高，且空闲盘区链较短。缺点是分配与回收的过程比较复杂。
3. 位视图法
4. 成组链接法